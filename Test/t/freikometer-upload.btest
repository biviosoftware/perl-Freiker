# Copyright (c) 2006-2007 bivio Software, Inc.  All Rights Reserved.
# $Id$
test_setup('Freiker');
home_page();
do_test_backdoor(TestData => '-realm fm_freikometer reset_freikometer_folders');
do_test_backdoor(TestData => 'reset_freikers');
my($epc) = test_use('Freiker::Test')->EPC;
my($date) = test_use('Type.DateTime')->local_now_as_file_name;
basic_authorization('fm_freikometer');
send_request(PUT => "/fm/$date.csv", undef, my $content = <<"EOF");
EPC,DateTime
$epc,$date
EOF
test_equals(qr{.*Download/test\.sh$}, get_uri());
test_equals("date\n", get_content());
home_page();
do_logout();
login_as('adm');
follow_link_in_table(qw(freikometer freikometer fm_freikometer action files));
follow_link(
    'upload',
    test_use('Type.Date')->local_now_as_file_name =~ /^(\d{6})/,
    "$date.csv",
);
test_equals($content, get_content());
go_back();
follow_link('bunit123456789');
verify_table(Date => [
    [qw(Date Trips)],
    [Type_Date()->to_string(Type_Date()->local_today), 1],
]);

