# Copyright (c) 2005 bivio Software, Inc. All rights reserved.
# $Id$
test_setup('Freiker');
home_page();
school_delete(my($zip) = '123456789');
follow_link('register your school');
submit_form('Register School' => {
    'Your Name:' => 'Big Wheel',
    'Your Email:' => (generate_local_email('big-wheel'))[0],
    'Password:' => 'password',
    'Re-enter Password:' => 'password',
    'Official Name:' => 'Big Wheel School',
    'US ZIP+4:' => $zip,
    'Website:' => 'http://big-wheel-school.org',
});
submit_form('Update' => {
    'Teacher_0' => 'Mr.',
    'First Name_0' => 'Teacher',
    'Last Name_0' => 'First',
    'Class Size_0' => '11',
    'Grade_0' => '1st',
    'Teacher_1' => 'Ms.',
    'First Name_1' => 'Teacher',
    'Last Name_1' => 'Second',
    'Class Size_1' => '99',
    'Grade_1' => '2nd',
});
verify_text(qr/First.*11.*Second.*99/s);
submit_form('Update');
my($school) = get_uri() =~ m{http://[^/]+/(\w+)};
my($code) = $school;
follow_link('Upload');
$code++;
use Bivio::Type::Date;
submit_form(Upload => {
    'Barcode File:' => file_field(
	Bivio::Type::Date->local_now_as_file_name, <<"EOF"),
@{[$code++]}
@{[$code++]}
@{[$code++]}
@{[$code++]}
@{[$code++]}
@{[$code++]}
EOF
});
my($v) = {};
$code = $school;
my($first_name_label);
do_table_rows(Barcode => sub {
    my($row, $index) = @_;
    $first_name_label = (grep(/First/i, keys(%$row)))[0];
    $code++;
    die("$row->{Barcode} eq $code")
	unless $row->{Barcode}->get('text') eq $code;
    $v->{"Class_$index"} = $index == 0 ? 'Select Class'
	: $index % 2 ? "1st Mr. Teacher First"
	: "2nd Ms. Teacher Second";
    $v->{"${first_name_label}_$index"} = $index == 2 ? '' : "first-$code";
    return 1;
});
submit_form(Assign => $v);
follow_link('Freikers');
verify_form($v);

#$get_to_reg->();
#test_deviance('You must supply a value for Your Name.');
#submit_form('Register School' => {
#    'Your Name:' => '',
#    'Your Email:' => 'first@test.com',
#    'Password:' => '123456',
#    'Re-enter Password:' => '123456',
#    'School Name:' => 'My School',
#    'School ZIP+4:' => '12345-6789',
#    'School Website:' => 'http://www.myschool.com',
#});
#test_conformance();
